<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Stats</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; margin: 0; background-color: #E0E7FF; display:flex; justify-content:center; padding:2rem; }
  .stats-container { background:#fff; padding:2rem; border-radius:15px; width:95%; max-width:1000px; box-shadow:0 10px 25px rgba(0,0,0,0.2); }
  .stats-header { color:#4857a2; margin-bottom:1.5rem; border-bottom:1px solid #ddd; padding-bottom:1rem; text-align:center; }
  .summary-boxes { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:1rem; margin-bottom:2rem; }
  .summary-box { background:#f9f9f9; border-radius:10px; padding:1rem; box-shadow:0 4px 10px rgba(0,0,0,0.05); text-align:center; }
  .summary-box h3 { margin:0; color:#4857a2; font-size:1.5rem; }
  .summary-box p { margin:0.3rem 0 0; font-size:0.9rem; color:#444; }
  table { width:100%; border-collapse:collapse; margin-top:1rem; }
  th, td { padding:0.8rem; border-bottom:1px solid #ddd; text-align:center; }
  th { background-color:#4857a2; color:#fff; font-weight:600; }
  tr:hover { background-color:#f1f1f1; }
  .back-link { display:inline-block; margin-top:1.5rem; text-decoration:none; background:#4857a2; color:#fff; padding:0.7rem 1.2rem; border-radius:8px; transition:0.3s; }
  .back-link:hover { background:#3043a2; }
  /* Modal styles */
  #reviewModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  #reviewModalContent { background:#fff; padding:2rem; border-radius:10px; max-width:800px; width:90%; max-height:80%; overflow-y:auto; position:relative; }
  #closeModal { position:absolute; top:10px; right:15px; font-size:1.5rem; cursor:pointer; }
  .correct { color:green; font-weight:bold; }
  .wrong { color:red; font-weight:bold; }
</style>
</head>
<body>
<div class="stats-container">
  <div class="stats-header">
    <h1><i class="fas fa-chart-line"></i> My Quiz Stats</h1>
  </div>

  <!-- Summary -->
  <div class="summary-boxes">
    <div class="summary-box"><h3>{{ total_quizzes }}</h3><p>Total Quizzes</p></div>
    <div class="summary-box"><h3>{{ average_score|floatformat:2 }}%</h3><p>Average Score</p></div>
    <div class="summary-box"><h3>{{ passed_quizzes }}</h3><p>Passed</p></div>
    <div class="summary-box"><h3>{{ failed_quizzes }}</h3><p>Failed</p></div>
  </div>

  <!-- Suggestion -->
  {% if suggestion %}
  <div style="background:#FFF3CD; border:1px solid #FFEEBA; color:#856404; padding:1rem; border-radius:10px; margin-bottom:1.5rem;">
    <i class="fas fa-lightbulb"></i> {{ suggestion }}
  </div>
  {% endif %}

  <!-- Individual Attempts -->
  <h2>Quiz Attempts</h2>
  <table>
    <tr>
      <th>Date</th>
      <th>Topic</th>
      <th>Subtopic</th>
      <th>Difficulty</th>
      <th>Score</th>
      <th>Correct</th>
      <th>Wrong</th>
      <th>Action</th>
    </tr>
    {% for res in results %}
    <tr>
      <td>{{ res.date_attempted|date:"Y-m-d H:i" }}</td>
      <td>{{ res.topic }}</td>
      <td>{{ res.subtopic }}</td>
      <td>{{ res.difficulty }}</td>
      <td>{{ res.score|floatformat:2 }}%</td>
      <td>{{ res.correct }}</td>
      <td>{{ res.wrong }}</td>
      <td><i class="fas fa-eye review-btn" data-quiz-code="{{ res.quiz_code }}" style="cursor:pointer;" title="Review Quiz"></i></td>
    </tr>
    {% empty %}
    <tr><td colspan="8">No quizzes attempted yet.</td></tr>
    {% endfor %}
  </table>

  <a href="{% url 'user_dashboard' %}" class="back-link"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
</div>

<!-- Modal -->
<div id="reviewModal">
  <div id="reviewModalContent">
    <span id="closeModal">&times;</span>
    <h2>Quiz Review</h2>
    <table id="modalTable" border="1" style="width:100%; border-collapse:collapse;">
      <tr>
        <th>Question</th>
        <th>Your Answer</th>
        <th>Correct Answer</th>
        <th>Status</th>
      </tr>
    </table>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const reviewButtons = document.querySelectorAll('.review-btn');
    const modal = document.getElementById('reviewModal');
    const closeModal = document.getElementById('closeModal');
    const modalTable = document.getElementById('modalTable');

    reviewButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const quizCode = btn.dataset.quizCode;

            const url = "{% url 'my_stats' %}";
            fetch(`${url}?quiz_code=${quizCode}`)
            .then(res => res.json())
            .then(data => {
                modalTable.innerHTML = `
                    <tr>
                      <th>Question</th>
                      <th>Your Answer</th>
                      <th>Correct Answer</th>
                      <th>Status</th>
                    </tr>
                `;

                if (data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="4">No answers found for this quiz.</td>`;
                    modalTable.appendChild(row);
                }

                data.forEach(a => {
                    const options = {
                        "A": a.question__option1,
                        "B": a.question__option2,
                        "C": a.question__option3,
                        "D": a.question__option4,
                    };

                    const normalize = (val) => {
                        if (!val) return "";
                        val = val.toUpperCase();
                        if (val.startsWith("OPTION1") || val === "1") return "A";
                        if (val.startsWith("OPTION2") || val === "2") return "B";
                        if (val.startsWith("OPTION3") || val === "3") return "C";
                        if (val.startsWith("OPTION4") || val === "4") return "D";
                        return val;
                    };

                    const selLetter = normalize(a.selected_option);
                    const corLetter = normalize(a.correct_answer);

                    const userAnsText = options[selLetter] || a.selected_option;
                    const correctAnsText = options[corLetter] || a.correct_answer;

                    const status = (selLetter === corLetter)
                                   ? '<span class="correct">✅ Correct</span>'
                                   : '<span class="wrong">❌ Wrong</span>';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${a.question__question}</td>
                        <td>${userAnsText} (${selLetter})</td>
                        <td>${correctAnsText} (${corLetter})</td>
                        <td>${status}</td>
                    `;
                    modalTable.appendChild(row);
                });

                modal.style.display = 'flex';
            })
            .catch(err => console.error("Fetch error:", err));
        });
    });

    closeModal.addEventListener('click', () => { modal.style.display = 'none'; });
    window.addEventListener('click', e => { if(e.target === modal) modal.style.display = 'none'; });
});
</script>
</body>
</html>
